<template lang="pug">
.mypage
  el-card.mypage__card
    .mypage__header(slot="header")
      h2 Mypage
    .mypage__row
      label メールアドレス
      el-input(v-model="email" readonly)
    .mypage__row
      label 表示名
      el-input(v-model="name")
    .mypage__row
      label プロフィール画像
      img.mypage__icon(v-if="currentImage" :src="currentImage")
      p(v-else) 現在登録されていません
      el-upload(
        list-type="picture-card" :limit="1" action="" :auto-upload="false"
        :file-list="imageList"
        :show-file-list="false" :on-change="handleFilesChange" :on-remove="handleFilesChange")
    .mypage__submit
      el-button(type="primary" @click="save") 保存
</template>

<script lang="ts">
import { defineComponent, reactive, toRefs, computed } from '@vue/composition-api'

import useAuthentication from '@/hooks/useAuthentication'

export default defineComponent({
  setup (_, context) {
    useAuthentication(context)

    const state = reactive<{
      email: string
      name: string
      currentImage: any
      image: any
    }>({
      email: '',
      name: '',
      currentImage: undefined,
      image: undefined
    })

    setTimeout(() => {
      const onAuthStateChanged = context.root.context.app.onAuthStateChanged
      const currentUser = context.root.$firebase.auth().currentUser
      if (onAuthStateChanged && currentUser) {
        state.email = currentUser.email
        state.name = currentUser.displayName
        state.currentImage = currentUser.photoURL
      }
    })

    const handleFilesChange = (file: any, fileList: any[]) => {
      if (fileList.length === 0) {
        state.image = null
        return
      }
      state.image = file
    }

    const save = () => {
      currentUser.updateProfile({
        displayName: state.name,
        photoURL: state.image || state.currentImage
      })
      context.root.$message({ message: '保存しました', type: 'success', duration: 5000 })
    }

    return {
      ...toRefs(state),
      handleFilesChange,
      save
    }
  }
})
</script>

<style lang="stylus" scoped>
.mypage
  background-color: #f4f4f4
  padding: 150px 0
  height: calc(100vh - 60px)
  &__card
    width: 400px
    margin: auto
    h2
      text-align: center
  &__row
    text-align: left
    margin-bottom: 16px
    label
      display: block
      margin-bottom: 8px
    p
      font-size: 14px
      color: #999
  &__submit
    text-align: center
  &__icon
    width: 80px
    height: 80px
    border-radius: 40px
</style>
